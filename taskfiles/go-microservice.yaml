---
version: 3

tasks:
  run-lint-stage:
    desc: Lint/validate multiple technologies (non-interactive, for calling from other taskfiles)
    vars:
      CI_MODULE: '{{.CI_MODULE | default "github.com/stuttgart-things/blueprints/go-microservice@v1.21.0"}}'
      FUNCTION: '{{.FUNCTION | default "run-static-stage"}}'
      SRC: '{{.SRC | default .USER_WORKING_DIR}}'
      TEST: '{{.TEST | default "false"}}'
      GO_VERSION: '{{.GO_VERSION | default "1.25.4"}}'
      LINT_CAN_FAIL: '{{.LINT_CAN_FAIL | default "true"}}'
      REPORT_PATH: '{{.REPORT_PATH | default "/tmp/all-findings.txt"}}'
    cmds:
      - |
        dagger call -m {{ .CI_MODULE }} {{ .FUNCTION }} \
        --src {{ .SRC }} \
        --lintCanFail={{ .LINT_CAN_FAIL }} \
        --go-Version={{ .GO_VERSION }} \
        --test={{ .TEST }} \
        --progress plain -vv \
        export --path={{ .REPORT_PATH }}
        cat {{ .REPORT_PATH }}

  run-lint-stage-interactive:
    desc: Lint/validate multiple technologies (interactive with prompts)
    vars:
      CI_MODULE:
        sh: |
          gum input --placeholder "CI Module" --value "github.com/stuttgart-things/blueprints/go-microservice@v1.21.0"
      FUNCTION:
        sh: |
          gum input --placeholder "Function name" --value "run-static-stage"
      SRC:
        sh: |
          gum input --placeholder "Source code dir" --value $(pwd)
      TEST:
        sh: |
          gum choose "true" "false" --header "Run tests?"
      GO_VERSION:
        sh: |
          gum input --placeholder "Go version" --value "1.25.4"
      LINT_CAN_FAIL:
        sh: |
          gum choose "true" "false" --header "Allow lint to fail?"
      REPORT_PATH:
        sh: |
          gum input --placeholder "Report path" --value "/tmp/all-findings.txt"
    cmds:
      - |
        dagger call -m {{ .CI_MODULE }} {{ .FUNCTION }} \
        --src {{ .SRC }} \
        --lintCanFail={{ .LINT_CAN_FAIL }} \
        --go-Version={{ .GO_VERSION }} \
        --test={{ .TEST }} \
        --progress plain -vv \
        export --path={{ .REPORT_PATH }}
        cat {{ .REPORT_PATH }}

  run-go-tests:
    desc: Run Go tests via Dagger CI (non-interactive, for calling from other taskfiles)
    vars:
      CI_MODULE: '{{.CI_MODULE | default "github.com/stuttgart-things/dagger/homerun@v0.42.0"}}'
      FUNCTION: '{{.FUNCTION | default "run-test-with-redis"}}'
      SRC: '{{.SRC | default .USER_WORKING_DIR}}'
      TEST_PATH: '{{.TEST_PATH | default "."}}'
      GO_VERSION: '{{.GO_VERSION | default "1.25.4"}}'
    cmds:
      - |
        dagger call -m {{ .CI_MODULE }} {{ .FUNCTION }} \
        --source {{ .SRC }} \
        --test-path={{ .TEST_PATH }} \
        --go-Version={{ .GO_VERSION }} \
        --progress plain -vv

  run-go-tests-interactive:
    desc: Run Go tests via Dagger CI (interactive with prompts)
    vars:
      CI_MODULE:
        sh: |
          gum input --placeholder "CI Module" --value "github.com/stuttgart-things/dagger/homerun@v0.42.0"
      FUNCTION:
        sh: |
          gum input --placeholder "Function name" --value "run-test-with-redis"
      SRC:
        sh: |
          gum input --placeholder "Source code dir" --value $(pwd)
      TEST_PATH:
        sh: |
          gum input --placeholder "Test path" --value "."
      GO_VERSION:
        sh: |
          gum input --placeholder "Go version" --value "1.25.4"
    cmds:
      - |
        dagger call -m {{ .CI_MODULE }} {{ .FUNCTION }} \
        --source {{ .SRC }} \
        --test-path={{ .TEST_PATH }} \
        --go-Version={{ .GO_VERSION }} \
        --progress plain -vv

  run-build-stage:
    desc: Run build stage for Go microservice (non-interactive, for calling from other taskfiles)
    vars:
      CI_MODULE: '{{.CI_MODULE | default "github.com/stuttgart-things/blueprints/go-microservice@v1.21.0"}}'
      FUNCTION: '{{.FUNCTION | default "run-build-stage"}}'
      SRC: '{{.SRC | default .USER_WORKING_DIR}}'
      KO_BUILD: '{{.KO_BUILD | default "false"}}'
      BIN_NAME: '{{.BIN_NAME | default "app"}}'
      LDFLAGS: '{{.LDFLAGS | default ""}}'
      KO_PUSH: '{{.KO_PUSH | default "false"}}'
      KO_VERSION: '{{.KO_VERSION | default "v0.18.0"}}'
      KO_REPO: '{{.KO_REPO | default "ghcr.io/your-org/your-repo"}}'
      EXPORT_PATH: '{{.EXPORT_PATH | default "/tmp/microservices/build-output/"}}'
    cmds:
      - |
        dagger call -m {{ .CI_MODULE }} {{ .FUNCTION }} \
        --src {{ .SRC }} \
        --ko-build={{ .KO_BUILD }} \
        --bin-name {{ .BIN_NAME }} \
        --ldflags "{{ .LDFLAGS }}" \
        --token=env:GITHUB_TOKEN \
        --ko-version={{ .KO_VERSION }} \
        --ko-push={{ .KO_PUSH }} \
        --ko-repo {{ .KO_REPO }} \
        --progress plain -vv \
        export --path={{ .EXPORT_PATH }}

  run-build-stage-interactive:
    desc: Run build stage for Go microservice with ldflags and ko build
    vars:
      CI_MODULE: github.com/stuttgart-things/blueprints/go-microservice@v1.21.0
      FUNCTION: run-build-stage
      SRC:
        sh: |
          gum input --placeholder "Source code dir" --value $(pwd)
      KO_BUILD:
        sh: |
          gum choose "true" "false" --header "Enable ko build?"
      BIN_NAME:
        sh: |
          gum input --placeholder "Binary name" --value "app"
      VERSION:
        sh: |
          gum input --placeholder "Version" --value "1.0.0"
      COMMIT:
        sh: |
          gum input --placeholder "Commit hash" --value $(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
      KO_PUSH:
        sh: |
          gum choose "true" "false" --header "Push to registry?"
      KO_REPO:
        sh: |
          gum input --placeholder "Ko repository" --value "ghcr.io/your-org/your-repo"
      EXPORT_PATH:
        sh: |
          gum input --placeholder "Export path" --value "/tmp/microservices/build-output/"
    cmds:
      - |
        dagger call -m {{ .CI_MODULE }} {{ .FUNCTION }} \
        --src {{ .SRC }} \
        --ko-build={{ .KO_BUILD }} \
        --bin-name {{ .BIN_NAME }} \
        --ldflags "" \
        --token=env:GITHUB_TOKEN \
        --ko-push={{ .KO_PUSH }} \
        --ko-repo {{ .KO_REPO }} \
        --progress plain -vv \
        export --path={{ .EXPORT_PATH }}

  lint-go:
    desc: Lint Go project (non-interactive, for calling from other taskfiles)
    vars:
      MODULE: '{{.MODULE | default "github.com/stuttgart-things/dagger/go@v0.42.0"}}'
      SRC: '{{.SRC | default "."}}'
      TIMEOUT: '{{.TIMEOUT | default "300s"}}'
    cmds:
      - |
        dagger call -m {{ .MODULE }} lint \
        --src "{{ .SRC }}" \
        --timeout {{ .TIMEOUT }} \
        --progress plain -vv

  lint-go-interactive:
    desc: Lint Go project (interactive with prompts)
    vars:
      MODULE:
        sh: |
          gum input --placeholder "Dagger module" --value "github.com/stuttgart-things/dagger/go@v0.42.0"
      SRC:
        sh: |
          gum input --placeholder "Source directory" --value "."
      TIMEOUT:
        sh: |
          gum input --placeholder "Timeout (e.g., 300s)" --value "300s"
    cmds:
      - |
        dagger call -m {{ .MODULE }} lint \
        --src "{{ .SRC }}" \
        --timeout {{ .TIMEOUT }} \
        --progress plain -vv

  build-binary:
    desc: Build Go binary with custom flags (non-interactive, for calling from other taskfiles)
    vars:
      MODULE: '{{.MODULE | default "github.com/stuttgart-things/dagger/go@v0.42.0"}}'
      SRC: '{{.SRC | default "."}}'
      OS: '{{.OS | default "linux"}}'
      ARCH: '{{.ARCH | default "amd64"}}'
      LDFLAGS: '{{.LDFLAGS | default ""}}'
      GO_MAIN_FILE: '{{.GO_MAIN_FILE | default "main.go"}}'
      BIN_NAME: '{{.BIN_NAME | default "myapp"}}'
      EXPORT_PATH: '{{.EXPORT_PATH | default "/tmp/go/build/"}}'
    cmds:
      - |
        dagger call -m {{ .MODULE }} build-binary \
        --src "{{ .SRC }}" \
        --os {{ .OS }} \
        --arch {{ .ARCH }} \
        --ldflags "{{ .LDFLAGS }}" \
        --go-main-file {{ .GO_MAIN_FILE }} \
        --bin-name {{ .BIN_NAME }} \
        export --path={{ .EXPORT_PATH }} \
        --progress plain -vv

  build-binary-interactive:
    desc: Build Go binary with custom flags (interactive with prompts)
    vars:
      MODULE:
        sh: |
          gum input --placeholder "Dagger module" --value "github.com/stuttgart-things/dagger/go@v0.42.0"
      SRC:
        sh: |
          gum input --placeholder "Source directory" --value "."
      OS:
        sh: |
          gum choose "linux" "darwin" "windows" --header "Target OS"
      ARCH:
        sh: |
          gum choose "amd64" "arm64" "arm" --header "Target architecture"
      VERSION:
        sh: |
          gum input --placeholder "Version" --value "1.0.0"
      BUILD_DATE:
        sh: |
          echo $(date -u +%Y-%m-%dT%H:%M:%SZ)
      GO_MAIN_FILE:
        sh: |
          gum input --placeholder "Go main file" --value "main.go"
      BIN_NAME:
        sh: |
          gum input --placeholder "Binary name" --value "myapp"
      EXPORT_PATH:
        sh: |
          gum input --placeholder "Export path" --value "/tmp/go/build/"
    cmds:
      - |
        dagger call -m {{ .MODULE }} build-binary \
        --src "{{ .SRC }}" \
        --os {{ .OS }} \
        --arch {{ .ARCH }} \
        --ldflags "cmd.version={{ .VERSION }}; cmd.date={{ .BUILD_DATE }}" \
        --go-main-file {{ .GO_MAIN_FILE }} \
        --bin-name {{ .BIN_NAME }} \
        export --path={{ .EXPORT_PATH }} \
        --progress plain -vv

  ko-build:
    desc: Build and push container with Ko (non-interactive, for calling from other taskfiles)
    vars:
      MODULE: '{{.MODULE | default "github.com/stuttgart-things/dagger/go@v0.42.0"}}'
      SRC: '{{.SRC | default "."}}'
      TOKEN_NAME: '{{.TOKEN_NAME | default "GITHUB_TOKEN"}}'
      REPO: '{{.REPO | default "ko.local"}}'
      BUILD_ARG: '{{.BUILD_ARG | default "."}}'
      KO_VERSION: '{{.KO_VERSION | default "v0.18.0"}}'
      PUSH: '{{.PUSH | default "true"}}'
    cmds:
      - |
        dagger call -m {{ .MODULE }} ko-build \
        --src {{ .SRC }} \
        --token env:{{ .TOKEN_NAME }} \
        --repo {{ .REPO }} \
        --build-arg {{ .BUILD_ARG }} \
        --ko-version {{ .KO_VERSION }} \
        --push {{ .PUSH }} \
        --progress plain -vv

  ko-build-interactive:
    desc: Build and push container with Ko (interactive with prompts)
    vars:
      MODULE:
        sh: |
          gum input --placeholder "Dagger module" --value "github.com/stuttgart-things/dagger/go@v0.42.0"
      SRC:
        sh: |
          gum input --placeholder "Source directory" --value "."
      TOKEN_NAME:
        sh: |
          gum input --placeholder "Token environment variable name" --value "GITHUB_TOKEN"
      REPO:
        sh: |
          gum input --placeholder "Container repository (e.g., ghcr.io/stuttgart-things/myapp)" --value "ko.local"
      BUILD_ARG:
        sh: |
          gum input --placeholder "Build argument (path to build)" --value "."
      KO_VERSION:
        sh: |
          gum input --placeholder "Ko version" --value "v0.18.0"
      PUSH:
        sh: |
          gum choose "true" "false" --header "Push to registry?"
    cmds:
      - |
        dagger call -m {{ .MODULE }} ko-build \
        --src {{ .SRC }} \
        --token env:{{ .TOKEN_NAME }} \
        --repo {{ .REPO }} \
        --build-arg {{ .BUILD_ARG }} \
        --ko-version {{ .KO_VERSION }} \
        --push {{ .PUSH }} \
        --progress plain -vv
