---
version: "3"
vars:
  INVENTORY_PATH: "/tmp/inventory"

tasks:
  create-kind-cluster:
    desc: Create a Kind Kubernetes cluster
    cmds:
      - |
        # Ask for target
        target=$(gum choose "localhost" "remote" --header="Target host?")

        if [ "$target" = "localhost" ]; then
          inventory_arg="-e target_host=localhost"
        else
          hostname=$(gum input --placeholder "Enter remote hostname or IP" --prompt "Remote host? ")
          echo "$hostname" > {{ .INVENTORY_PATH }}-kind
          inventory_arg="-i {{ .INVENTORY_PATH }}-kind"
        fi

        kind_cluster_name=$(gum input --placeholder "Enter Kind cluster name" --value "dev")
        provision_cluster=$(gum choose true false --header="Provision cluster?")
        ansible_user=$(gum input --placeholder "Enter Ansible user" --prompt "ansible user? " --value "sthings")
        kubectl_version=$(gum input --placeholder "Enter kubectl version" --prompt "kubernetes version? " --value "1.34.0")

        # Construct the command
        cmd="ansible-playbook sthings.container.kind \
          $inventory_arg \
          -e kind_cluster_name=$kind_cluster_name \
          -e provision_cluster=$provision_cluster \
          -e ansible_user=$ansible_user \
          -e kubectl_version=$kubectl_version \
          -vv"

        # Print the command for review
        echo
        gum style --border normal --border-foreground 212 --padding "1 2" --margin "1 0" --foreground 212 "About to execute:"
        gum style --border double --border-foreground 99 --padding "1 2" "$cmd"
        echo

        # Confirm before execution
        gum confirm "Proceed with execution?" || exit 1

        # Execute
        eval "$cmd"

        # Optional cleanup
        if [ "$target" != "localhost" ]; then
          gum confirm "Delete temporary inventory file (/tmp/inf)?" && rm -f /tmp/inf
        fi
